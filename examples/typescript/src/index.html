<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1"/>
        <title>ESP Tool</title>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@4.19.0/css/xterm.css">
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Orbitron:wght@600&display=swap" rel="stylesheet"/>
    <!-- Favicon removed per request -->
        <link rel="stylesheet" href="./styles.css" />
        <script src="https://cdn.jsdelivr.net/npm/xterm@4.19.0/lib/xterm.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.js"></script>
    </head>
    <body>
    <div class="container">

            <div id="safariErr" style="display:none" class="alert mt-12">
                <span id="alertmsg">This tool is not supported on Safari browser!</span>
            </div>

            <main id="main">
                <section class="card" id="connect">
                    <div class="card-header">
                        <h2 class="card-title">Connect <span id="connStatusDot" class="status-dot status-red" title="Disconnected" aria-label="Disconnected"></span></h2>
                        <div class="row">
                            <label style="display:none" id="lblConnTo">Connected to device:</label>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="alert mt-12" id="connectAlert" style="display:none;">
                            <span class="close" onclick="this.parentElement.style.display='none'">&times;</span>
                            <span id="connectAlertMsg"></span>
                        </div>
                        <div class="row connect-actions">
                            <input class="btn btn-primary" type="button" id="connectButton" value="Connect" />
                            <input class="btn btn-warning" type="button" id="disconnectButton" value="Disconnect" />
                        </div>
                        <details class="advanced mt-8">
                            <summary>Advanced</summary>
                            <div class="advanced-body">
                                <div class="row">
                                    <label class="field" for="baudrates" id="lblBaudrate">Baudrate:
                                        <select name="baudrates" id="baudrates">
                                            <option value="921600">921600</option>
                                            <option value="460800">460800</option>
                                            <option value="230400">230400</option>
                                            <option value="115200">115200</option>
                                        </select>
                                    </label>
                                    <label class="toggle" for="debugLogging">
                                        <input type="checkbox" id="debugLogging" checked />
                                        Debug
                                    </label>
                                </div>
                                <div class="row mt-8">
                                    <input class="btn btn-secondary" type="button" id="copyTraceButton" value="Copy Trace" />
                                </div>
                            </div>
                        </details>
                    </div>
                </section>
            <ul class="tabs mt-32" id="tabs">
                <li class="tab disabled" data-target="program">Flashing</li>
                <li class="tab disabled" data-target="console">Console</li>
                <li class="tab disabled" data-target="tools">Tools</li>
            </ul>
    <section class="card" id="program" style="display:none;">
                    <div class="card-body">

                        <div class="alert mt-12 mb-12" id="alertDiv" style="display:none;">
                            <span class="close" onclick="this.parentElement.style.display='none'">&times;</span>
                            <span id="programAlertMsg"></span>
                        </div>
                        <div id="files">
                            <div id="prebuiltRow" class="row mt-12">
                                <label class="field" for="prebuiltSelect">Firmware:
                                    <select id="prebuiltSelect">
                                        <option value="">Select firmware‚Ä¶</option>
                                    </select>
                                </label>
                            </div>

                            <details class="advanced mt-12">
                                <summary>Advanced</summary>
                                <div class="advanced-body">
                                    <div class="row mt-8">
                                        <input class="btn btn-danger" type="button" id="eraseButton" value="Erase Flash" />
                                    </div>
                                    <table id="fileTable">
                                        <thead>
                                            <tr>
                                                <th>Flash Address</th>
                                                <th>File</th>
                                                <th></th>
                                            </tr>
                                        </thead>
                                        <tbody id="tableBody"></tbody>
                                    </table>
                                    <div class="row mt-8">
                                        <input class="btn btn-secondary" type="button" id="addFile" value="Add File" />
                                    </div>
                                </div>
                            </details>

                            <div class="row mt-12">
                                <input class="btn btn-primary" type="button" id="programButton" value="Flash" />
                            </div>
                        </div>
                        <output id="list"></output>
                    </div>
                </section>

                                <section class="card" id="console" style="display:none;">
                    <div class="card-body">
                        <div class="row">
                            <label style="display:none" id="lblConsoleFor">Connected</label>
                        </div>
                        <div class="row">
                            <input class="btn btn-primary" type="button" id="consoleStartButton" value="Start" />
                            <input class="btn btn-secondary" type="button" id="consoleStopButton" value="Stop" />
                            <input class="btn btn-secondary" type="button" id="resetButton" value="Reset" />
                            <span class="spacer"></span>
                            <button class="btn btn-secondary" id="terminalExpandBtn" type="button" title="Expand console">‚§¢ Expand</button>
                        </div>
                        <div class="mt-12 terminal-wrapper" id="terminalWrapper">
                            <div class="terminal-bar" id="terminalBar">
                                <div class="title">Console</div>
                                <div class="actions">
                                    <button class="btn btn-secondary" id="terminalCloseBtn" type="button" title="Close">‚úï Close</button>
                                </div>
                            </div>
                            <div id="terminal"></div>
                        </div>
                    </div>
                </section>
                <section class="card" id="tools" style="display:none;">
                    <div class="card-body">
                        <ul class="subtabs" id="toolTabs" role="tablist" aria-label="Setup tools">
                            <li class="subtab active" role="tab" aria-selected="true" data-target="tool-wifi">üì∂ WiFi</li>
                            <li class="subtab" role="tab" aria-selected="false" data-target="tool-mdns">üåê mDNS</li>
                            <li class="subtab" role="tab" aria-selected="false" data-target="tool-uvc">üíª UVC Name</li>
                            <li class="subtab" role="tab" aria-selected="false" data-target="tool-stream">üöÄ Streaming</li>
                            <li class="subtab" role="tab" aria-selected="false" data-target="tool-mode">üîÑ Device Mode</li>
                            <li class="subtab" role="tab" aria-selected="false" data-target="tool-pwm">üí° LEDs</li>
                            <li class="subtab" role="tab" aria-selected="false" data-target="tool-logs">üìñ Logs</li>
                            <li class="subtab" role="tab" aria-selected="false" data-target="tool-summary">üß© Summary</li>
                        </ul>
                        <div class="tool-panels">
                            <div id="tool-wifi" class="tool-panel" role="tabpanel" style="display:block;">
                                <div class="row">
                                    <input class="btn btn-secondary" type="button" id="wifiScanButton" value="Scan" />
                                </div>
                                <div class="row mt-8" id="wifiHint" style="display:none;">
                                    <span class="muted">Select a network below and then press Connect.</span>
                                </div>
                                <table id="wifiTable" class="mt-8 wifi-table" style="display:none;">
                                    <thead>
                                        <tr>
                                            <th class="col-select">Select</th>
                                            <th>Network</th>
                                            <th>signal Strength</th>
                                        </tr>
                                    </thead>
                                    <tbody id="wifiTableBody"></tbody>
                                </table>
                                <div class="row mt-12" id="wifiSelectionBox" style="display:none; align-items: center; gap: 12px;">
                                    <span class="muted">Selected:</span>
                                    <strong id="wifiSelectedSsidLabel"></strong>
                                    <label class="field" id="wifiPwdField" style="display:none;">Password: <input type="password" id="wifiPassword" placeholder="Password" /></label>
                                    <input class="btn btn-primary" type="button" id="wifiConnectButton" value="Connect" />
                                </div>
                                <div class="row mt-8">
                                    <span id="wifiStatusMsg" class="muted"></span>
                                </div>
                            </div>
                            <div id="tool-mdns" class="tool-panel" role="tabpanel" style="display:none;"></div>
                            <div id="tool-uvc" class="tool-panel" role="tabpanel" style="display:none;"></div>
                            <div id="tool-stream" class="tool-panel" role="tabpanel" style="display:none;"></div>
                            <div id="tool-mode" class="tool-panel" role="tabpanel" style="display:none;">
                                <div class="row">
                                    <span class="muted">Current mode:</span>
                                    <strong id="modeStatus" style="margin-left:8px;">-</strong>
                                </div>
                                <div class="row mt-16" id="modeChoices">
                                    <label class="radio" style="margin-right:16px;"><input type="radio" name="devMode" value="wifi"> WiFi</label>
                                    <label class="radio" style="margin-right:16px;"><input type="radio" name="devMode" value="uvc"> UVC</label>
                                    <label class="radio"><input type="radio" name="devMode" value="auto"> Auto</label>
                                </div>
                                <div class="row mt-16">
                                    <button class="btn btn-primary" id="modeApplyButton" type="button">Apply</button>
                                    <span id="modeMsg" class="muted" style="margin-left:12px;"></span>
                                </div>
                            </div>
                            <div id="tool-pwm" class="tool-panel" role="tabpanel" style="display:none;">
                                <div class="row">
                                    <span class="muted">Current LED brightness:</span>
                                    <strong id="pwmStatus" style="margin-left:8px;">-</strong>
                                </div>
                                <div class="row mt-16" id="pwmControls">
                                    <label class="field" style="gap:10px;">
                                        <span>LED brightness:</span>
                                        <input type="range" id="pwmSlider" min="0" max="100" value="0" style="width:200px;">
                                        <input type="number" id="pwmNumber" min="0" max="100" value="0" style="width:72px;">
                                    </label>
                                </div>
                                <div class="row mt-8">
                                    <span id="pwmMsg" class="muted"></span>
                                </div>
                            </div>
                            <div id="tool-logs" class="tool-panel" role="tabpanel" style="display:none;"></div>
                            <div id="tool-summary" class="tool-panel" role="tabpanel" style="display:none;">
                                <div class="row">
                                    <span class="muted">MAC:</span>
                                    <strong id="sumMac" style="margin-left:8px;">-</strong>
                                </div>
                                <div class="row mt-12">
                                    <span class="muted">LED brightness:</span>
                                    <strong id="sumLed" style="margin-left:8px;">-</strong>
                                </div>
                                <div class="row mt-12">
                                    <span class="muted">Mode:</span>
                                    <strong id="sumMode" style="margin-left:8px;">-</strong>
                                </div>
                                <div class="row mt-12">
                                    <span class="muted">WiFi:</span>
                                    <strong id="sumWifiStatus" style="margin-left:8px;">-</strong>
                                    <span class="muted" style="margin-left:12px;">IP:</span>
                                    <strong id="sumWifiIp" style="margin-left:8px;">-</strong>
                                    <span class="muted" style="margin-left:12px;">Configured:</span>
                                    <strong id="sumWifiConfigured" style="margin-left:8px;">-</strong>
                                </div>
                                <div class="row mt-12">
                                    <span id="sumMsg" class="muted"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
        <!-- Persistent Debug panel below all tab pages -->
        <section class="card mt-32" id="debugPanel">
                <div class="card-header">
                    <h2 class="card-title">Debug</h2>
                    <div class="row" style="gap:12px; align-items:center;">
                        <button class="btn btn-secondary" id="debugClearBtn" type="button">Clear</button>
                        <label class="toggle" for="debugAutoScroll">
                            <input type="checkbox" id="debugAutoScroll" checked /> Auto-scroll
                        </label>
                    </div>
                </div>
                <div class="card-body">
            <div id="debugLog" style="max-height:160px; overflow:auto; background:#0b0b0b; color:#ddd; padding:8px; border-radius:6px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; line-height:1.4;"></div>
                </div>
            </section>
            </main>
        </div>
        <script src="index.ts" type="module"></script>
                <script>
            // Toggle Debug panel with Advanced > Debug checkbox
            (function(){
                function syncDebugPanel(){
                    var cb = document.getElementById('debugLogging');
                    var panel = document.getElementById('debugPanel');
                    if (!panel) return;
                    var show = true;
                    try { show = !!(cb && cb.checked); } catch(e){}
                    panel.style.display = show ? 'block' : 'none';
                }
                document.addEventListener('DOMContentLoaded', syncDebugPanel);
                window.addEventListener('load', syncDebugPanel);
                document.addEventListener('change', function(e){
                    var t = e.target; if (!t || !t.matches) return;
                    try { if (t.matches('#debugLogging')) syncDebugPanel(); } catch(_){}
                });
                // First sync in case scripts run after HTML parsed
                syncDebugPanel();
            })();
            // Safari 3.0+ "[object HTMLElementConstructor]"
            var isSafari = /constructor/i.test(window.HTMLElement) || (function (p) { return p.toString() === "[object SafariRemoteNotification]"; })(!window['safari'] || (typeof safari !== 'undefined' && window['safari'].pushNotification));

            if(isSafari)
            {
               document.getElementById("safariErr").style.display = "block";
               document.getElementById("main").style.display = "none";
            }
                        // Console expand/close controls
                        (function(){
                            var wrap = document.getElementById('terminalWrapper');
                            var bar = document.getElementById('terminalBar');
                            var btnExpand = document.getElementById('terminalExpandBtn');
                            var btnClose = document.getElementById('terminalCloseBtn');
                            var isFull = false;
                function setFull(full){
                                isFull = full;
                                wrap.classList.toggle('fullscreen', !!full);
                                document.body.style.overflow = full ? 'hidden' : '';
                                // Resize rows to suit mode (simple heuristic)
                                try {
                    if (window.adjustTerminalSize) window.adjustTerminalSize();
                    else if (window.term && typeof window.term.resize === 'function') { window.term.resize(120, full ? 40 : 20); }
                                } catch(e){}
                                setTimeout(function(){ window.dispatchEvent(new Event('resize')); }, 60);
                            }
                            if (btnExpand) btnExpand.addEventListener('click', function(){ setFull(true); });
                            if (btnClose) btnClose.addEventListener('click', function(){ setFull(false); });
                            document.addEventListener('keydown', function(e){ if(e.key === 'Escape' && isFull){ setFull(false); }});
                        })();
                        // Enable tabs when connected (auto-switch to Flashing)
                                                (function(){
                                                    var lblConnTo = document.getElementById('lblConnTo');
                                                    var tabProgram = document.querySelector('#tabs .tab[data-target="program"]');
                                                    var tabConsole = document.querySelector('#tabs .tab[data-target="console"]');
                                                    var tabTools = document.querySelector('#tabs .tab[data-target="tools"]');
                                                    function enable(){
                                                        tabProgram && tabProgram.classList.remove('disabled');
                                                        tabConsole && tabConsole.classList.remove('disabled');
                                                        tabTools && tabTools.classList.remove('disabled');
                            // Switch to Flashing when a connection is established
                            if (tabProgram) { tabProgram.click(); }
                                                    }
                                                    var mo = new MutationObserver(function(){
                                                        if (lblConnTo && lblConnTo.style.display !== 'none') { enable(); }
                                                    });
                                                    if (lblConnTo) mo.observe(lblConnTo, { attributes: true, attributeFilter: ['style'] });
                                                })();
                                                // Tabs switching
                        (function(){
                                                    var tabs = Array.from(document.querySelectorAll('#tabs .tab'));
                                                    function show(id){
                            ['program','console','tools'].forEach(function(section){
                                                            var el = document.getElementById(section);
                                                            if (el) el.style.display = (section === id) ? 'block' : 'none';
                                                        });
                                                    }
                                                    tabs.forEach(function(tab){
                                                        tab.addEventListener('click', function(){
                                                            if (tab.classList.contains('disabled')) return;
                                                            // Block Tools tab when not connected, align with other tabs
                                                            if (!window.isConnected && tab.dataset.target === 'tools') return;
                                                            var leavingConsole = document.querySelector('#tabs .tab.active[data-target="console"]');
                                                            if (leavingConsole && tab.dataset.target !== 'console' && window.softStopConsole) {
                                                                try { window.softStopConsole(); } catch(e){}
                                                            }
                                                            tabs.forEach(function(t){ t.classList.remove('active'); });
                                                            tab.classList.add('active');
                                                            show(tab.dataset.target);
                                                            if (tab.dataset.target === 'console') setTimeout(function(){ window.dispatchEvent(new Event('resize')); }, 60);
                                                        });
                                                    });
                                                    // initial: both hidden, Connect visible by default
                                                    show(null);
                                                })();
                                                // Subtabs (Tools) switching
                                                (function(){
                                                    var subtabs = Array.from(document.querySelectorAll('#toolTabs .subtab'));
                                                    function showPanel(id){
                                                        var panels = Array.from(document.querySelectorAll('.tool-panel'));
                                                        panels.forEach(function(p){ p.style.display = (p.id === id) ? 'block' : 'none'; });
                                                    }
                                                    subtabs.forEach(function(tab){
                                                        tab.addEventListener('click', function(){
                                                            subtabs.forEach(function(t){ t.classList.remove('active'); t.setAttribute('aria-selected','false'); });
                                                            tab.classList.add('active');
                                                            tab.setAttribute('aria-selected','true');
                                                            showPanel(tab.dataset.target);
                                                        });
                                                    });
                                                    var firstActive = document.querySelector('#toolTabs .subtab.active');
                                                    if (firstActive) showPanel(firstActive.getAttribute('data-target'));
                                                })();
        </script>
    </body>
</html>
